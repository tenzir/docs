name: Update

on:
  workflow_call:
    inputs:
      product:
        description: "Product to update (node or platform)"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      product:
        description: "Product to update"
        required: true
        type: choice
        options:
          - node
          - platform

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: "update-${{ inputs.product }}"
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Input
    runs-on: ubuntu-latest
    steps:
      - name: Validate product parameter
        run: |
          if [[ "${{ inputs.product }}" != "node" && "${{ inputs.product }}" != "platform" ]]; then
            echo "Error: product must be either 'node' or 'platform'"
            exit 1
          fi
          echo "Valid product: ${{ inputs.product }}"

  update:
    name: Update Docs
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update Tenzir Node docs
        if: inputs.product == 'node'
        run: |
          echo "Updating Tenzir Node docs..."
          git clone --depth 1 https://github.com/tenzir/tenzir.git /tmp/tenzir
          # Install poetry and dependencies for changelog script
          pip install poetry
          cd docs/changelog
          poetry install --no-root
          # Run changelog script
          poetry run ./changelog.py --product=node /tmp/tenzir/changelog
          # Clean up
          rm -rf /tmp/tenzir

      - name: Update Tenzir Platform docs
        if: inputs.product == 'platform'
        run: |
          echo "Updating Tenzir Platform docs..."

      - name: Set up Git user
        uses: fregante/setup-git-user@v2

      - name: Commit changes
        run: |
          product="Tenzir ${{ inputs.product == 'node' && 'Node' || 'Platform' }}"
          if git diff --quiet; then
            echo "ℹ️ No changes needed for $product documentation"
          else
            git add .
            git commit -m "Update $product documentation"
            git push
            echo "✅ Updated and committed $product documentation"
          fi
