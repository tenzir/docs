name: Build & Deploy

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write # needed for committing changes
  pages: write
  id-token: write
  pull-requests: write # needed for commenting on PRs

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Generate app token
        if: github.event_name == 'pull_request'
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.TENZIR_GITHUB_APP_ID }}
          private-key: ${{ secrets.TENZIR_GITHUB_APP_PRIVATE_KEY }}
          repositories: docs-previews

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for checking changes and pushing
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Generate changelog
        run: bun run generate:changelog

      - name: Generate Claude plugins
        run: bun run generate:claude-plugins

      - name: Build OCSF schemas
        if: github.event_name != 'pull_request'
        id: ocsf
        uses: ./.github/actions/build-ocsf
        with:
          include-dev: "true"

      - name: Generate OCSF reference
        if: github.event_name != 'pull_request'
        env:
          OCSF_LOCAL_DIR: ${{ steps.ocsf.outputs.schemas-dir }}
        run: bun run generate:ocsf:all

      - name: Generate Excalidraw SVGs
        run: bun run generate:excalidraw

      - name: Setup GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build with Astro
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Skip link checking for PR previews - the validator doesn't handle
            # non-root base paths, and main branch builds catch broken links.
            bun run astro build \
              --site "https://preview.docs.tenzir.com" \
              --base "/${{ github.event.pull_request.number }}"
          else
            CHECK_LINKS=true LLMS_TXT=true bun run astro build \
              --site "${{ steps.pages.outputs.origin }}" \
              --base "${{ steps.pages.outputs.base_path }}"
          fi

      - name: Upload artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      # The upload-pages-artifact action filters to web-servable content only
      # (HTML, CSS, JS, images), stripping raw .md files. The Release job needs
      # these markdown files to build the agent skill, so we upload them separately.
      # Note: The glob pattern roots at dist/, so files are stored without the
      # dist/ prefix and must be downloaded to dist/ in the Release job.
      - name: Upload markdown files for release
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: markdown-files
          path: dist/**/*.md
          retention-days: 1

      - name: Deploy PR Preview
        if: github.event_name == 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          repository-name: tenzir/docs-previews
          folder: dist
          target-folder: ${{ github.event.pull_request.number }}
          branch: gh-pages
          clean: false
          token: ${{ steps.app-token.outputs.token }}

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = 'https://preview.docs.tenzir.com/${{ github.event.pull_request.number }}';
            const comment = [
              '<!-- docs-preview -->',
              `ðŸ“¦ **Preview** &nbsp;Â·&nbsp; [View â†’](${url}) &nbsp;Â·&nbsp; ðŸŸ¢ Live`,
              '',
              '<sub>Auto-updates on push</sub>'
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('<!-- docs-preview -->')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  deploy:
    name: Deploy
    if: github.ref == 'refs/heads/main'
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    name: Release
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: artifact

      - name: Extract artifact
        run: |
          mkdir -p dist
          tar -xf artifact/artifact.tar -C dist

      - name: Download markdown files
        uses: actions/download-artifact@v4
        with:
          name: markdown-files
          path: dist

      - name: Debug - List markdown files
        run: |
          echo "=== Files in dist/ ==="
          find dist -name "*.md" | head -20
          echo "=== Total .md files ==="
          find dist -name "*.md" | wc -l
          echo "=== Sitemap check ==="
          ls -la dist/sitemap.md || echo "sitemap.md NOT FOUND"
          echo "=== First link in sitemap ==="
          grep -o '](https://docs.tenzir.com/[^)]*\.md)' dist/sitemap.md | head -3 || echo "No .md links found"
          echo "=== First 50 lines of sitemap ==="
          head -50 dist/sitemap.md

      - name: Fix index.md naming
        run: |
          [ -f dist/.md ] && mv dist/.md dist/index.md || true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Create tarball bundle
        run: |
          mkdir -p bundle

          # Copy all .md files preserving structure (except sitemap)
          rsync -a --include='*/' --include='*.md' --exclude='sitemap.md' --exclude='*' dist/ bundle/

          # Copy sitemap with relative URLs and strip timestamp
          sed -e 's|https://docs.tenzir.com/||g' -e '/^> Last updated:/d' dist/sitemap.md > bundle/sitemap.md

          # Create tarball
          tar -czf tenzir-docs.tar.gz -C bundle .

      - name: Generate single-file bundle
        run: |
          {
            echo "# Tenzir Documentation"
            echo ""
            echo "> Auto-generated from https://docs.tenzir.com"
            echo ""

            # Process files by section, demoting headings
            for section in guides tutorials explanations reference integrations; do
              if [ -d "bundle/$section" ]; then
                echo "# ${section^}"
                echo ""
                find "bundle/$section" -name '*.md' -type f | sort | while read -r file; do
                  sed 's/^#/##/' "$file"
                  echo ""
                  echo "---"
                  echo ""
                done
              fi
            done
          } > tenzir-docs.md

      - name: Build skill
        run: |
          bun run build:skill
          tar -czf tenzir-skill.tar.gz -C tenzir .

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Validate skill
        run: |
          uv tool install git+https://github.com/agentskills/agentskills.git#subdirectory=skills-ref
          skills-ref validate tenzir

      - name: Delete existing release assets
        run: |
          gh release view latest --json assets -q '.assets[].name' 2>/dev/null | while read -r asset; do
            gh release delete-asset latest "$asset" --yes
          done || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set timestamp
        run: echo "TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')" >> "$GITHUB_ENV"

      - name: Update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Tenzir Documentation
          body: |
            The complete docs in structured Markdown. Built for MCP servers, AI assistants, or those who just like it plain.

            **Download:**
            - ðŸ“¦ [`tenzir-docs.tar.gz`](https://github.com/tenzir/docs/releases/download/latest/tenzir-docs.tar.gz): Structured directory of markdown files
            - ðŸ“„ [`tenzir-docs.md`](https://github.com/tenzir/docs/releases/download/latest/tenzir-docs.md): Single file with proper heading hierarchy
            - ðŸ¤– [`tenzir-skill.tar.gz`](https://github.com/tenzir/docs/releases/download/latest/tenzir-skill.tar.gz): [Agent Skill](https://agentskills.io) with progressive disclosure

            *Auto-generated on ${{ env.TIMESTAMP }} from commit [`${{ github.sha }}`](https://github.com/tenzir/docs/commit/${{ github.sha }})*
          files: |
            tenzir-docs.tar.gz
            tenzir-docs.md
            tenzir-skill.tar.gz
          make_latest: true
