name: Build & Deploy

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write # needed for committing changes
  pages: write
  id-token: write
  pull-requests: write # needed for commenting on PRs

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for checking changes and pushing
          submodules: recursive

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Generate changelog
        run: pnpm generate:changelog

      - name: Generate Claude plugins
        run: pnpm generate:claude-plugins

      - name: Generate OCSF reference
        run: pnpm generate:ocsf:all

      - name: Generate docs map
        run: pnpm generate:docs-map

      - name: Generate Excalidraw SVGs
        run: pnpm generate:excalidraw

      - name: Setup GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build with Astro
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHECK_LINKS=true pnpm astro build \
              --site "https://tenzir-docs-preview-${{ github.event.pull_request.number }}.surge.sh"
          else
            CHECK_LINKS=true LLMS_TXT=true pnpm astro build \
              --site "${{ steps.pages.outputs.origin }}" \
              --base "${{ steps.pages.outputs.base_path }}"
          fi

      - name: Upload artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy PR Preview
        if: github.event_name == 'pull_request'
        run: |
          # To create a surge.sh token, run `npx durge login` and `npx surge token`.
          npm install -g surge
          surge ./dist https://tenzir-docs-preview-${{ github.event.pull_request.number }}.surge.sh --token ${{ secrets.SURGE_TOKEN }}

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `ðŸš€ **Preview deployed!**

            Visit the preview at: https://tenzir-docs-preview-${{ github.event.pull_request.number }}.surge.sh

            This preview will be updated automatically on new commits.`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview deployed!')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  deploy:
    name: Deploy
    if: github.ref == 'refs/heads/main'
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    name: Release
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: artifact

      - name: Extract artifact
        run: |
          mkdir -p dist
          tar -xf artifact/artifact.tar -C dist

      - name: Fix index.md naming
        run: |
          [ -f dist/.md ] && mv dist/.md dist/index.md || true

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create tarball bundle
        run: |
          mkdir -p bundle

          # Copy all .md files preserving structure (except sitemap)
          rsync -a --include='*/' --include='*.md' --exclude='sitemap.md' --exclude='*' dist/ bundle/

          # Copy sitemap with relative URLs and strip timestamp
          sed -e 's|https://docs.tenzir.com/||g' -e '/^> Last updated:/d' dist/sitemap.md > bundle/sitemap.md

          # Create tarball
          tar -czf tenzir-docs.tar.gz -C bundle .

      - name: Generate single-file bundle
        run: |
          {
            echo "# Tenzir Documentation"
            echo ""
            echo "> Auto-generated from https://docs.tenzir.com"
            echo ""

            # Process files by section, demoting headings
            for section in guides tutorials explanations reference integrations; do
              if [ -d "bundle/$section" ]; then
                echo "# ${section^}"
                echo ""
                find "bundle/$section" -name '*.md' -type f | sort | while read -r file; do
                  sed 's/^#/##/' "$file"
                  echo ""
                  echo "---"
                  echo ""
                done
              fi
            done
          } > tenzir-docs.md

      - name: Generate skill
        run: |
          pnpm generate:skill
          tar -czf tenzir-skill.tar.gz -C tenzir .

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Validate skill
        run: |
          uv tool install git+https://github.com/agentskills/agentskills.git#subdirectory=skills-ref
          skills-ref validate tenzir

      - name: Delete existing release assets
        run: |
          gh release view latest --json assets -q '.assets[].name' 2>/dev/null | while read -r asset; do
            gh release delete-asset latest "$asset" --yes
          done || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set timestamp
        run: echo "TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')" >> "$GITHUB_ENV"

      - name: Update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Tenzir Documentation
          body: |
            The complete docs in structured Markdown. Built for MCP servers, AI assistants, or those who just like it plain.

            **Download:**
            - ðŸ“¦ [`tenzir-docs.tar.gz`](https://github.com/tenzir/docs/releases/download/latest/tenzir-docs.tar.gz): Structured directory of markdown files
            - ðŸ“„ [`tenzir-docs.md`](https://github.com/tenzir/docs/releases/download/latest/tenzir-docs.md): Single file with proper heading hierarchy
            - ðŸ¤– [`tenzir-skill.tar.gz`](https://github.com/tenzir/docs/releases/download/latest/tenzir-skill.tar.gz): [Agent Skill](https://agentskills.io) with progressive disclosure

            *Auto-generated on ${{ env.TIMESTAMP }} from commit [`${{ github.sha }}`](https://github.com/tenzir/docs/commit/${{ github.sha }})*
          files: |
            tenzir-docs.tar.gz
            tenzir-docs.md
            tenzir-skill.tar.gz
          make_latest: true
