---
import { Badge, Icon } from '@astrojs/starlight/components';
import Default from '@astrojs/starlight/components/Sidebar.astro';

import { topicParents, childTopics, dropdownTopics } from '../topics.ts';
import TopicDropdown from './TopicDropdown.astro';
import changelogProjects from '../changelog-projects.json';

const { topics } = Astro.locals.starlightSidebarTopics;

// Look up color by topic link (handles various formats: "changelog/tenzir", "/changelog/tenzir/", etc.)
const getTopicColor = (link: string | undefined): string | undefined => {
  if (!link) return undefined;
  // Normalize: remove leading/trailing slashes
  const normalized = link.replace(/^\/|\/$/g, '');
  if (!normalized.startsWith('changelog/')) return undefined;
  const projectId = normalized.slice('changelog/'.length);
  return changelogProjects[projectId as keyof typeof changelogProjects]?.color;
};

// Find the current topic
const currentTopic = topics.find((topic) => topic.isCurrent);
if (!currentTopic) {
  console.warn('No current topic found — skipping topic-specific rendering');
}

// If current is a root → show its children
// If current is a child → show its siblings
const currentLabel = currentTopic?.label || '';
const parentLabel = topicParents[currentLabel];
const rootLabel = parentLabel ?? currentLabel;

// Get the list of child topic labels (could be empty)
const sidebarTopicLabels = childTopics(rootLabel);
const sidebarTopics = topics.filter((t) => sidebarTopicLabels.includes(t.label));

// Check if this root topic uses a dropdown
const useDropdown = dropdownTopics.has(rootLabel);

// Prepare dropdown data - look up colors from changelog-projects.json since
// starlight-sidebar-topics doesn't pass through custom properties
const dropdownItems = useDropdown
  ? sidebarTopics.map((t) => ({
      label: t.label,
      link: t.link,
      icon: t.icon,
      color: getTopicColor(t.link),
      isCurrent: t.isCurrent,
    }))
  : [];
---

{useDropdown && dropdownItems.length > 0 ? (
  <TopicDropdown items={dropdownItems} />
) : sidebarTopics.length > 0 && (
  <ul class="starlight-sidebar-topics">
    {
      sidebarTopics.map((topic) => (
        <li>
          <a href={topic.link} class:list={{ 'starlight-sidebar-topics-current': topic.isCurrent }}>
            {topic.icon && (
              <div class="starlight-sidebar-topics-icon" data-color={getTopicColor(topic.link)}>
                <Icon name={topic.icon} />
              </div>
            )}
            <div>
              {topic.label}
              {topic.badge && (
                <Badge
                  class="starlight-sidebar-topics-badge"
                  text={topic.badge.text}
                  variant={topic.badge.variant}
                />
              )}
            </div>
          </a>
        </li>
      ))
    }
  </ul>
)}

<Default><slot /></Default>

<style>
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  ul::after {
    content: '';
    display: block;
    margin-top: var(--tnz-space-4);
    height: 1px;
    background-color: var(--tnz-neutral-700);
  }

  :root[data-theme='light'] ul::after {
    background-color: var(--tnz-neutral-200);
  }

  li {
    overflow-wrap: anywhere;
    background-color: transparent !important;
    border-radius: 0 !important;
  }

  li + li {
    margin-top: var(--tnz-space-0-5);
  }

  a {
    align-items: center;
    color: var(--tnz-neutral-400);
    display: flex;
    font-size: var(--tnz-text-sm);
    font-weight: var(--tnz-font-medium);
    gap: var(--tnz-space-2);
    line-height: var(--tnz-leading-sm);
    padding: var(--tnz-space-2) var(--tnz-space-2-5);
    text-decoration: none;
    transition: color var(--tnz-transition-base);
    border-left: 2px solid transparent;
    margin-left: 0;
    padding-left: calc(var(--tnz-space-2-5) - 2px);
    /* Explicit resets to override any inherited styles */
    background-color: transparent !important;
    border-radius: 0 !important;
    box-shadow: none !important;
  }

  a:hover,
  a:focus-visible {
    color: var(--sl-color-white);
    background-color: transparent !important;
  }

  a:focus-visible {
    outline: none;
  }

  a.starlight-sidebar-topics-current {
    color: var(--sl-color-white);
    border-left-color: var(--tnz-primary-500);
    background-color: transparent !important;
  }

  /* Light mode */
  :root[data-theme='light'] a {
    color: var(--tnz-neutral-500);
  }

  :root[data-theme='light'] a:hover,
  :root[data-theme='light'] a:focus-visible {
    color: var(--tnz-neutral-800);
  }

  :root[data-theme='light'] a.starlight-sidebar-topics-current {
    color: var(--tnz-neutral-800);
  }

  /* Icon container */
  .starlight-sidebar-topics-icon {
    align-items: center;
    border-radius: var(--tnz-radius-sm);
    border: 1px solid var(--tnz-neutral-600);
    background-color: transparent;
    display: flex;
    justify-content: center;
    padding: var(--tnz-space-1);
    transition: border-color var(--tnz-transition-base);
    flex-shrink: 0;
  }

  a:hover .starlight-sidebar-topics-icon,
  a:focus-visible .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-500);
  }

  a.starlight-sidebar-topics-current .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-400);
  }

  :root[data-theme='light'] .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-300);
  }

  :root[data-theme='light'] a:hover .starlight-sidebar-topics-icon,
  :root[data-theme='light'] a:focus-visible .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-400);
  }

  :root[data-theme='light'] a.starlight-sidebar-topics-current .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-500);
  }

  /* Colored icons - subtle tint blended into neutral base */
  .starlight-sidebar-topics-icon[data-color='blue'] {
    color: color-mix(in srgb, var(--tnz-primary-500) 80%, var(--tnz-neutral-400));
  }
  .starlight-sidebar-topics-icon[data-color='green'] {
    color: color-mix(in srgb, var(--tnz-green-500) 80%, var(--tnz-neutral-400));
  }
  .starlight-sidebar-topics-icon[data-color='purple'] {
    color: color-mix(in srgb, var(--tnz-purple-500) 80%, var(--tnz-neutral-400));
  }
  .starlight-sidebar-topics-icon[data-color='orange'] {
    color: color-mix(in srgb, var(--tnz-orange-500) 80%, var(--tnz-neutral-400));
  }
  .starlight-sidebar-topics-icon[data-color='lightblue'] {
    color: color-mix(in srgb, var(--tnz-lightblue-500) 80%, var(--tnz-neutral-400));
  }
  .starlight-sidebar-topics-icon[data-color='pink'] {
    color: color-mix(in srgb, var(--tnz-pink-500) 80%, var(--tnz-neutral-400));
  }
  .starlight-sidebar-topics-icon[data-color='yellow'] {
    color: color-mix(in srgb, var(--tnz-yellow-500) 80%, var(--tnz-neutral-400));
  }
  .starlight-sidebar-topics-icon[data-color='red'] {
    color: color-mix(in srgb, var(--tnz-red-500) 80%, var(--tnz-neutral-400));
  }

  /* Light mode icon colors */
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='blue'] {
    color: color-mix(in srgb, var(--tnz-primary-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='green'] {
    color: color-mix(in srgb, var(--tnz-green-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='purple'] {
    color: color-mix(in srgb, var(--tnz-purple-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='orange'] {
    color: color-mix(in srgb, var(--tnz-orange-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='lightblue'] {
    color: color-mix(in srgb, var(--tnz-lightblue-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='pink'] {
    color: color-mix(in srgb, var(--tnz-pink-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='yellow'] {
    color: color-mix(in srgb, var(--tnz-yellow-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .starlight-sidebar-topics-icon[data-color='red'] {
    color: color-mix(in srgb, var(--tnz-red-500) 80%, var(--tnz-neutral-500));
  }

  .starlight-sidebar-topics-badge {
    margin-inline-start: var(--tnz-space-1);
  }
</style>
