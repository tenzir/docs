---
import MobileMenuFooter from "virtual:starlight/components/MobileMenuFooter";
import { Badge } from "@astrojs/starlight/components";
import SidebarPersister from "@astrojs/starlight/components/SidebarPersister.astro";
import changelogProjects from "../changelog-projects.json";
import { childTopics, dropdownTopics, topicParents } from "../topics.ts";
import { getIconComponent } from "../utils/icon-registry";
import SidebarSublist from "./SidebarSublist.astro";
import TopicDropdown from "./TopicDropdown.astro";

const { topics } = Astro.locals.starlightSidebarTopics;
const { sidebar } = Astro.locals.starlightRoute;

// Look up color by topic link (handles various formats: "changelog/tenzir", "/changelog/tenzir/", etc.)
const getTopicColor = (link: string | undefined): string | undefined => {
  if (!link) return undefined;
  // Normalize: remove leading/trailing slashes
  const normalized = link.replace(/^\/|\/$/g, "");
  if (!normalized.startsWith("changelog/")) return undefined;
  const projectId = normalized.slice("changelog/".length);
  return changelogProjects[projectId as keyof typeof changelogProjects]?.color;
};

// Find the current topic (may be undefined on non-topic pages)
const currentTopic = topics.find((topic) => topic.isCurrent);

// If current is a root → show its children
// If current is a child → show its siblings
const currentLabel = currentTopic?.label || "";
const parentLabel = topicParents[currentLabel];
const rootLabel = parentLabel ?? currentLabel;

// Get the list of child topic labels (could be empty)
const sidebarTopicLabels = childTopics(rootLabel);
const sidebarTopics = topics.filter((t) =>
  sidebarTopicLabels.includes(t.label),
);

// Check if this root topic uses a dropdown
const useDropdown = dropdownTopics.has(rootLabel);

// Prepare dropdown data - look up colors from changelog-projects.json since
// starlight-sidebar-topics doesn't pass through custom properties
const dropdownItems = useDropdown
  ? sidebarTopics.map((t) => ({
      label: t.label,
      link: t.link,
      icon: t.icon,
      color: getTopicColor(t.link),
      isCurrent: t.isCurrent,
    }))
  : [];
---

{useDropdown && dropdownItems.length > 0 ? (
  <TopicDropdown items={dropdownItems} />
) : sidebarTopics.length > 0 && (
  <ul class="starlight-sidebar-topics">
    {
      sidebarTopics.map((topic) => {
        const iconName = typeof topic.icon === 'string' ? topic.icon : topic.icon?.name;
        const IconComponent = iconName ? getIconComponent(iconName) : undefined;
        return (
          <li>
            <a href={topic.link} class:list={{ 'starlight-sidebar-topics-current': topic.isCurrent }}>
              {IconComponent && (
                <div class="starlight-sidebar-topics-icon" data-color={getTopicColor(topic.link)}>
                  <IconComponent />
                </div>
              )}
              <div>
                {topic.label}
                {topic.badge && (
                  <Badge
                    class="starlight-sidebar-topics-badge"
                    text={topic.badge.text}
                    variant={topic.badge.variant}
                  />
                )}
              </div>
            </a>
          </li>
        );
      })
    }
  </ul>
)}

<SidebarPersister>
  <SidebarSublist sublist={sidebar} />
</SidebarPersister>

<div class="md:sl-hidden">
  <MobileMenuFooter />
</div>

<style>
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  ul::after {
    content: '';
    display: block;
    margin-top: var(--tnz-space-4);
    height: 1px;
    background-color: var(--tnz-neutral-700);
  }

  :root[data-theme='light'] ul::after {
    background-color: var(--tnz-neutral-200);
  }

  li {
    overflow-wrap: anywhere;
    background-color: transparent !important;
    border-radius: 0 !important;
  }

  li + li {
    margin-top: var(--tnz-space-0-5);
  }

  a {
    align-items: center;
    color: var(--tnz-nav-link);
    display: flex;
    font-size: var(--tnz-text-sm);
    font-weight: var(--tnz-font-medium);
    gap: var(--tnz-space-2);
    line-height: var(--tnz-leading-sm);
    padding: var(--tnz-space-2) var(--tnz-space-2-5);
    text-decoration: none;
    transition: color var(--tnz-transition-base);
    border-left: 2px solid transparent;
    margin-left: 0;
    padding-left: calc(var(--tnz-space-2-5) - 2px);
    /* Explicit resets to override any inherited styles */
    background-color: transparent !important;
    border-radius: 0 !important;
    box-shadow: none !important;
  }

  a:hover,
  a:focus-visible {
    color: var(--tnz-nav-link-hover);
    background-color: transparent !important;
  }

  a:focus-visible {
    outline: none;
  }

  a.starlight-sidebar-topics-current {
    color: var(--tnz-nav-link-active) !important;
    border-left-color: var(--tnz-primary-500);
    background-color: transparent !important;
  }


  /* Icon container */
  .starlight-sidebar-topics-icon {
    align-items: center;
    border-radius: var(--tnz-radius-sm);
    border: 1px solid var(--tnz-neutral-600);
    background-color: transparent;
    display: flex;
    justify-content: center;
    padding: var(--tnz-space-1);
    transition: border-color var(--tnz-transition-base);
    flex-shrink: 0;
  }

  a:hover .starlight-sidebar-topics-icon,
  a:focus-visible .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-500);
  }

  a.starlight-sidebar-topics-current .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-400);
  }

  :root[data-theme='light'] .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-300);
  }

  :root[data-theme='light'] a:hover .starlight-sidebar-topics-icon,
  :root[data-theme='light'] a:focus-visible .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-400);
  }

  :root[data-theme='light'] a.starlight-sidebar-topics-current .starlight-sidebar-topics-icon {
    border-color: var(--tnz-neutral-500);
  }

  /* Icon colors - neutral grey */
  .starlight-sidebar-topics-icon {
    color: var(--tnz-neutral-600);
  }

  :root[data-theme='light'] .starlight-sidebar-topics-icon {
    color: var(--tnz-neutral-600);
  }

  .starlight-sidebar-topics-badge {
    margin-inline-start: var(--tnz-space-1);
  }
</style>
