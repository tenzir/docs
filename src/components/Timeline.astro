---
import { Icon } from "@astrojs/starlight/components";
import { remark } from "remark";
import remarkHtml from "remark-html";
import type { StarlightIcon } from "@astrojs/starlight/components/Icons";

/**
 * Timeline component for changelog pages.
 *
 * Structure:
 *   [dot] [content: header + description]
 *
 * The connecting line between entries is drawn using a pseudo-element
 * on each entry (except the last), positioned absolutely to span from
 * below the current dot to the top of the next dot.
 *
 * When showProjectInfo is true, displays project icon and name:
 *   [dot] [icon] Project Name > Module   v1.0.0   Dec 21, 2025
 */
interface ProjectInfo {
  icon?: StarlightIcon;
  color?: string;
  name: string;
  parentName?: string;
}

interface TimelineEntry {
  version: string;
  date: string;
  href: string;
  description?: string;
  project?: ProjectInfo;
}

interface Props {
  entries: TimelineEntry[];
  showProjectInfo?: boolean;
}

const { entries, showProjectInfo = false } = Astro.props;

async function renderMarkdown(text: string): Promise<string> {
  const result = await remark().use(remarkHtml).process(text);
  return String(result);
}

const renderedEntries = await Promise.all(
  entries.map(async (entry) => ({
    ...entry,
    renderedDescription: entry.description
      ? await renderMarkdown(entry.description)
      : undefined,
  })),
);

const isLastEntry = (index: number) => index === renderedEntries.length - 1;
---

<ul class="timeline">
  {renderedEntries.map((entry, index) => (
    <li
      class:list={[
        "timeline-entry",
        { "timeline-entry--last": isLastEntry(index), "timeline-entry--compact": !entry.renderedDescription },
      ]}
    >
      <a href={entry.href} class="timeline-link">
        <div class:list={["timeline-dot", { "timeline-dot--first": index === 0 }]} />
        <div class="timeline-header">
          {showProjectInfo && entry.project && (
            <span class="timeline-project">
              {entry.project.icon && (
                <span class="timeline-project-icon" data-color={entry.project.color}>
                  <Icon name={entry.project.icon} size="1rem" />
                </span>
              )}
              <span class="timeline-project-name">
                {entry.project.parentName ? `${entry.project.parentName} > ${entry.project.name}` : entry.project.name}
              </span>
            </span>
          )}
          <span class="timeline-version">{entry.version}</span>
          <time class="timeline-date">{entry.date}</time>
        </div>
        {entry.renderedDescription && (
          /* eslint-disable-next-line astro/no-set-html-directive */
          <div class="timeline-description" set:html={entry.renderedDescription} />
        )}
      </a>
    </li>
  ))}
</ul>

<style>
  .timeline {
    --timeline-dot-size: 10px;
    --timeline-line-width: 2px;
    --timeline-header-line-height: 1.6em;
    --timeline-dot-offset: calc((var(--timeline-header-line-height) - var(--timeline-dot-size)) / 2);
    list-style: none;
    margin: 0;
    margin-top: var(--tnz-space-4);
    padding: 0;
  }

  .timeline-entry {
    position: relative;
    margin-top: 0; /* Reset Starlight's .sl-markdown-content margin */
  }

  /* Vertical line connecting to next entry - drawn as pseudo-element */
  .timeline-entry:not(.timeline-entry--last)::before {
    content: '';
    position: absolute;
    /* Center the 2px line under the 10px dot: (10 - 2) / 2 = 4px from left edge of dot */
    /* The dot is at left: 0, so line is at left: 4px */
    left: calc((var(--timeline-dot-size) - var(--timeline-line-width)) / 2);
    /* Start below the dot: offset + dot size */
    top: calc(var(--timeline-dot-offset) + var(--timeline-dot-size));
    /* Extend into next entry to meet the next dot's top edge */
    /* Next dot starts at the same offset, so extend by that amount */
    bottom: calc(-1 * var(--timeline-dot-offset));
    width: var(--timeline-line-width);
    background: var(--tnz-neutral-600);
    transition: background-color var(--tnz-transition-base);
  }

  :root[data-theme='light'] .timeline-entry:not(.timeline-entry--last)::before {
    background: var(--tnz-neutral-250);
  }

  .timeline-entry:not(.timeline-entry--last):hover::before {
    background: var(--tnz-neutral-500);
  }

  :root[data-theme='light'] .timeline-entry:not(.timeline-entry--last):hover::before {
    background: var(--tnz-neutral-300);
  }

  .timeline-link {
    display: grid;
    grid-template-columns: var(--timeline-dot-size) minmax(0, 1fr);
    column-gap: var(--tnz-space-3);
    row-gap: var(--tnz-space-1);
    align-items: start;
    color: inherit;
    position: relative;
    padding-bottom: var(--tnz-space-4);
  }

  .timeline-entry--last .timeline-link {
    padding-bottom: 0;
  }

  .timeline-entry--compact .timeline-link {
    padding-bottom: var(--tnz-space-2);
  }

  :global(.sl-markdown-content) .timeline-link,
  :global(.sl-markdown-content) .timeline-link:visited,
  :global(.sl-markdown-content) .timeline-link:hover,
  :global(.sl-markdown-content) .timeline-link:active {
    color: inherit;
  }

  .timeline-link,
  .timeline-link * {
    text-decoration: none !important;
  }

  .timeline-dot {
    width: var(--timeline-dot-size);
    height: var(--timeline-dot-size);
    border-radius: 50%;
    background: var(--tnz-neutral-500);
    flex-shrink: 0;
    margin-top: var(--timeline-dot-offset) !important;
    /* Ensure dot appears above the line */
    position: relative;
    z-index: 1;
    transition: background-color var(--tnz-transition-base);
    grid-column: 1;
    grid-row: 1;
  }

  :root[data-theme='light'] .timeline-dot {
    background: var(--tnz-neutral-300);
  }

  .timeline-link:hover .timeline-dot {
    background: var(--tnz-primary-500);
  }

  /* Right column: header + description */
  .timeline-header {
    display: flex;
    align-items: center;
    gap: var(--tnz-space-2);
    flex-wrap: wrap;
    margin-top: 0; /* Reset Starlight's .sl-markdown-content margin */
    width: 100%;
    line-height: var(--timeline-header-line-height);
    font-size: var(--tnz-text-base);
    color: inherit;
    grid-column: 2;
    grid-row: 1;
    min-width: 0;
  }

  .timeline-version {
    font-weight: 600;
    color: inherit;
  }

  .timeline-date {
    font-size: var(--tnz-text-sm);
    margin-left: auto;
    flex-shrink: 0;
    color: var(--tnz-neutral-500);
  }

  :root[data-theme='light'] .timeline-date {
    color: var(--tnz-neutral-400);
  }

  .timeline-description {
    margin-top: 0;
    font-size: var(--tnz-text-sm);
    line-height: 1.6;
    color: var(--tnz-neutral-400);
    grid-column: 2;
    grid-row: 2;
  }

  :root[data-theme='light'] .timeline-description {
    color: var(--tnz-neutral-600);
  }

  .timeline-description :global(p) {
    margin: 0;
  }

  .timeline-description :global(code) {
    background: var(--tnz-neutral-700);
    border: 1px solid var(--tnz-neutral-600);
    padding: var(--tnz-space-0-5) var(--tnz-space-1);
    border-radius: var(--tnz-radius-sm);
    font-family: var(--tnz-font-mono);
    font-size: 0.9em;
  }

  :root[data-theme='light'] .timeline-description :global(code) {
    background: var(--tnz-neutral-100);
    border-color: var(--tnz-neutral-250);
  }

  /* Project info display (when showProjectInfo is true) */
  .timeline-project {
    display: inline-flex;
    align-items: center;
    gap: var(--tnz-space-1);
  }

  .timeline-project-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: var(--tnz-neutral-400);
  }

  :root[data-theme='light'] .timeline-project-icon:not([data-color]) {
    color: var(--tnz-neutral-500);
  }

  /* Icon colors - reuse pattern from LinkCard */
  .timeline-project-icon[data-color='blue'] {
    color: color-mix(in srgb, var(--tnz-primary-500) 80%, var(--tnz-neutral-400));
  }
  .timeline-project-icon[data-color='green'] {
    color: color-mix(in srgb, var(--tnz-green-500) 80%, var(--tnz-neutral-400));
  }
  .timeline-project-icon[data-color='purple'] {
    color: color-mix(in srgb, var(--tnz-purple-500) 80%, var(--tnz-neutral-400));
  }
  .timeline-project-icon[data-color='orange'] {
    color: color-mix(in srgb, var(--tnz-orange-500) 80%, var(--tnz-neutral-400));
  }
  .timeline-project-icon[data-color='lightblue'] {
    color: color-mix(in srgb, var(--tnz-lightblue-500) 80%, var(--tnz-neutral-400));
  }
  .timeline-project-icon[data-color='pink'] {
    color: color-mix(in srgb, var(--tnz-pink-500) 80%, var(--tnz-neutral-400));
  }
  .timeline-project-icon[data-color='yellow'] {
    color: color-mix(in srgb, var(--tnz-yellow-500) 80%, var(--tnz-neutral-400));
  }
  .timeline-project-icon[data-color='red'] {
    color: color-mix(in srgb, var(--tnz-red-500) 80%, var(--tnz-neutral-400));
  }

  :root[data-theme='light'] .timeline-project-icon[data-color='blue'] {
    color: color-mix(in srgb, var(--tnz-primary-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .timeline-project-icon[data-color='green'] {
    color: color-mix(in srgb, var(--tnz-green-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .timeline-project-icon[data-color='purple'] {
    color: color-mix(in srgb, var(--tnz-purple-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .timeline-project-icon[data-color='orange'] {
    color: color-mix(in srgb, var(--tnz-orange-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .timeline-project-icon[data-color='lightblue'] {
    color: color-mix(in srgb, var(--tnz-lightblue-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .timeline-project-icon[data-color='pink'] {
    color: color-mix(in srgb, var(--tnz-pink-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .timeline-project-icon[data-color='yellow'] {
    color: color-mix(in srgb, var(--tnz-yellow-500) 80%, var(--tnz-neutral-500));
  }
  :root[data-theme='light'] .timeline-project-icon[data-color='red'] {
    color: color-mix(in srgb, var(--tnz-red-500) 80%, var(--tnz-neutral-500));
  }

  .timeline-project-name {
    font-weight: 500;
    white-space: nowrap;
    color: inherit;
  }

</style>
